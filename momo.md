# 開発メモ


## 実装すること

- [x] 時間で```Animation```
- [x] 3Dモデルの読み込み
- [ ] UI
- [ ] 空(遠景)
- [ ] 3Dモデルへのテクスチャ適用
- [ ] テクスチャのミップマップとかのテクスチャ周りの実装の洗練
- [ ] 3Dモデルのリギング (```Model3D```を階層構造化する必要があると思う)
- [ ] fbx(というか3Dモデル)のリソースキャッシュ (fbxを毎回parseするのは遅い、ロード高速化のため)
- [ ] 物理演算
- [ ] 音
- [ ] シーン定義xml (静的な初期状態)とそのリソースキャッシュ
- アキュムレーションバッファでいろいろ (モーションブラー、アンチエイリアス等)
- [ ] フォグ
- [ ] フォント描画
- [ ] 影

## メモ

### 全体的なの

```GL.Clear()```でクリアできるバッファは4種類
カラーバッファ・デプスバッファ・アキュムレーションバッファ・ステンシルバッファ

```GL.Flush()```はOpenGLのクライアント側にあるコマンドを全てサーバーに転送する。有限時間内にサーバーでコマンドが処理されることを保証するが、完了は待たない。

```GL.Finish()```は```GL.Flush()```に加え、サーバーからの完了通知を待つ。

```GL.Enable(Normalize)```は負荷がかかる。頂点の座標変換を行わない場合、常に最初から正規化されている(もちろｎ正規化されている法線を与えている場合に限るが)はずなので不要

16000頂点のオブジェクトを100個(計160万頂点)の描画と、36頂点のオブジェクトを10000個(計36万)個描画が同じぐらいカクカクする。
と言うことは、頂点限界は数百万以上あると考えられるのに、オブジェクト数が多いと1つあたりのオーバーヘッドがボトルネックになっている。(？かもしれない)
ので、複数のオブジェクトをまとめてGPUに送るような何かを考える必要がある？(あるいは、単純にオブジェクト数を増やしすぎないようなゲーム側の実装を心がける必要があるかもしれない。パーティクル)
とりあえずCPU側のボトルネックなのかGPU側なのかを確認する必要あり。

### バッファ関連

```GL.BufferData()```でサーバー側のVRAMを確保するが、VRAMが不足して確保に失敗する```GL_OUT_OF_MEMORY```エラーが返ってくるので適切に処理しなければならない。(```GL.Error```に返ってくる？)

```GL.BufferSubData()```でバッファ内の値の一部のみを更新できる。モデルとか動かすのに使うと思う。

OpenGLのステート変数は属性グループに属しており、一括でスタックに保存可能。```GL.PushAttrib()```, ```GL.PushClientAttrib()```。取り出すときはポップすればいい。保存する変数はマスクできる。

### 座標変換・投影

変換行列は、自分で行列を作って```GL.MultMatrix()```するよりも、```GL.Translate()```, ```GL.Rotate()```, ```GL.Scale()```する方が速い。

```GL.ClipPlane()```で、表示の一部だけをクリップして不要部の描画を省略できる。最低6つまでクリップは保証されている。実装ごとのクリップの最大数は```glGetIntegerv(GL_MAX_CLIP_PLAINS)```で取得可能。

### Lighting

- ライティングモデルについて。

ライティングモデルのパラメータを```GL.LightModel()```で設定する。
グローバルなAmbientを設定できる。
片面だけ/両面のライティングを指定可能。
観測者の位置(無限点 or 近くの座標)を指定可能(無限点の方が高速)。
ほかにもある。

- セカンダリカラー

マテリアルに基づいたライティングの後にテクスチャが適用されるため、Speculerが弱めに見える場合がある。Speculerをテクスチャ適用後に実行するようにできる。
```glLightModeli(GL_LIGHT_MODEL_COLOR_CONTROL, GL_SEPARETE_SPECULAR_COLOR)```
戻すときは
```glLightModeli(GL_LIGHT_MODEL_COLOR_CONTROL, GL_SINGLE_COLOR)```

カラーマテリアル
```GL.ColorMaterial()```でマテリアルの色(デフォルトはAmbientとDiffuse)が常にプライマリ色になるようにできる。```GL.Material()```で各色を変えるより低負荷。

## 既知のバグ

- DirectInputでの右スティックの入力がおかしい。

とりあえずXInputにすれば動く模様。
GamePadクラスじゃなくてもう一つの方のクラスに変えてみれば生けるかも？(未検証)
